<?xml version="1.0" encoding="utf-8"?>

<aiscript name="JP_GetNearestUnknownObject_AEV2" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd">

  <order id="JP_GetNearestUnknownObject_AEV2" name="_GetNearestUnknownObject_AEV2" category="internal" infinite="false">
    <params>
      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      <param name="UNKNOWN_SECTORS" type="internal" default="true"/>
      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      <param name="JUMP_GATES" type="internal" default="true"/>
      <param name="STATIONS" type="internal" default="true"/>
      <param name="ENEMY_STATIONS" type="internal" default="false"/>
      <param name="FRIENDLY_STATIONS" type="internal" default="true"/>
      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      <!-- If specified.. the script will only search inside $SECTOR for unknown objects.. otherwise.. it will search the whole galaxy -->
      <param name="SECTOR" type="internal" default="null"/>
      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      <param name="DEBUG_FOLDER_NAME" type="internal" default="''"/>
      <param name="DEBUG" type="internal" default="0"/>
      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    </params>
  </order>

  <interrupts>
  </interrupts>

  <init>
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <set_value name="$Ship" exact="this.ship"/>
    <set_value name="$NearestUnknownObject" exact="null"/>
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <do_if value="$DEBUG gt 0">
      <set_value name="$DebugFolderName" exact="$DEBUG_FOLDER_NAME"/>
      <set_value name="$DebugScriptName" exact="'JP_GetNearestUnknownObject_AEV2'"/>
      <set_value name="$DebugFileName" exact="$Ship.idcode + '.' + $DebugScriptName + '.xml.log'"/>
      <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'" append="false"/>
      <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ ' + $DebugScriptName + '.xml ~ Started ~~' + '\n'"/>
    </do_if>
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <include_interrupt_actions ref="GetBlacklistgroup"/>
    <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
  </init>

  <attention min="unknown">
    <actions>

      <label name="INIT_LBL"/>
      <wait min="1ms"/>

      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

      <set_command command="command.scan"/>
      <set_command_action commandaction="commandaction.calculating"/>
      
      <do_if value="@$SECTOR != null and @$SECTOR.isclass.{class.sector}">
        <create_list name="$_Sectors"/>
        <append_to_list name="$_Sectors" exact="$SECTOR"/>
        <resume label="FIND_OBJECTS_LBL"/>
      </do_if>

      <create_list name="$_Sectors"/>
      <do_if value="$UNKNOWN_SECTORS">
        <find_sector name="$_Sectors" space="player.galaxy" multiple="true">
          <match_gate_distance object="$Ship" min="0"/>
          <match_use_blacklist object="$Ship" type="blacklisttype.sectortravel" group="$blacklistgroup"/>
          <match_use_blacklist object="$Ship" type="blacklisttype.sectoractivity" group="$blacklistgroup"/>
        </find_sector>
      </do_if>
      <do_else>
        <find_sector name="$_Sectors" space="player.galaxy" multiple="true">
          <match knownto="$Ship.owner"/>
          <match_gate_distance object="$Ship" min="0"/>
          <match_use_blacklist object="$Ship" type="blacklisttype.sectortravel" group="$blacklistgroup"/>
          <match_use_blacklist object="$Ship" type="blacklisttype.sectoractivity" group="$blacklistgroup"/>
        </find_sector>
      </do_else>

      <do_if value="global.$AnotherExplorerV2SectorBlackList?">
        <remove_from_list name="$_Sectors" list="global.$AnotherExplorerV2SectorBlackList"/>
      </do_if>

      <do_if value="$DEBUG">
        <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
        <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$_Sectors'"/>
        <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
        <do_for_each name="$_Sector" in="$_Sectors">
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~ Sector: ' + $_Sector.knownname + ' ~ ' + $_Sector.gatedistance.{$Ship}"/>
        </do_for_each>
        <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
      </do_if>

      <do_if value="$_Sectors.count gt 1">
        <sort_list list="$_Sectors" sortbyvalue="$Ship.gatedistance.{loop.element}"/>
        <do_if value="$DEBUG">
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'Sorted $_Sectors'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <do_for_each name="$_Sector" in="$_Sectors">
            <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~ Sector: ' + $_Sector.knownname + ' ~ ' + $_Sector.gatedistance.{$Ship}"/>
          </do_for_each>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
        </do_if>
      </do_if>

      <label name="FIND_OBJECTS_LBL"/>
      <do_for_each name="$_Sector" in="$_Sectors">

        <create_list name="$_FoundObjects"/>

        <!-- Append jump gates? -->
        <do_if value="$JUMP_GATES">
          <find_gate name="$_FoundObjects" space="$_Sector" multiple="true">
            <match knownto="$Ship.owner" negate="true"/>
          </find_gate>
        </do_if>

        <!-- Append stations? -->
        <do_if value="$STATIONS">
          <create_list name="$_FoundStations"/>
          <find_station name="$_FoundStations" space="$_Sector" multiple="true">
            <match knownto="$Ship.owner" negate="true"/>
          </find_station>
          <do_for_each name="$_Station" in="$_FoundStations">
            <do_if value="$_Station.owner.mayattack.{$Ship} and not $ENEMY_STATIONS">
              <continue/>
            </do_if>
            <do_if value="not $_Station.owner.mayattack.{$Ship} and not $FRIENDLY_STATIONS">
              <continue/>
            </do_if>
            <append_to_list name="$_FoundObjects" exact="$_Station"/>
          </do_for_each>
          <remove_value name="$_FoundStations"/>
        </do_if>

        <!-- sort and get nearest -->
        <do_if value="$_FoundObjects.count gt 0">
          <do_if value="$_FoundObjects.count gt 1">
            <sort_list list="$_FoundObjects" sortbyvalue="$Ship.distanceto.{loop.element}"/>
          </do_if>
          <set_value name="$NearestUnknownObject" exact="$_FoundObjects.{1}"/>
          <remove_value name="$_FoundObjects"/>
          <break/>
        </do_if>
        <remove_value name="$_FoundObjects"/>

      </do_for_each>

      <!-- adding it to the blacklist -->
      <do_if value="@$NearestUnknownObject != null">
        <do_if value="not global.$AnotherExplorerV2SectorBlackList?">
          <create_list name="global.$AnotherExplorerV2SectorBlackList"/>
        </do_if>
        <append_to_list name="global.$AnotherExplorerV2SectorBlackList" exact="$NearestUnknownObject.sector"/>
      </do_if>


      <wait min="1ms"/>

      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

      <label name="FINISH_LBL"/>
      <do_if value="$DEBUG gt 0">
        <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ ' + $DebugScriptName + '.xml ~ Finished ~~'"/>
        <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
      </do_if>
      <wait min="1ms"/>

      <label name="CLEANUP_LBL"/>
      <do_if value="$DEBUG gt 0">
        <remove_value name="$DebugFileName"/>
        <remove_value name="$DebugScriptName"/>
        <remove_value name="$DebugFolderName"/>
      </do_if>
      <remove_value name="$Ship"/>

      <label name="END_LBL"/>
      <wait min="1ms"/>


      <label name="RETURN_LBL"/>
      <return>
        <retval name="NEAREST_UNKNOWN_OBJECT" value="$NearestUnknownObject"/>
      </return>

    </actions>
  </attention>

  <on_abort>
    <do_if value="$DEBUG gt 0">
      <remove_value name="$DebugFileName"/>
      <remove_value name="$DebugScriptName"/>
      <remove_value name="$DebugFolderName"/>
    </do_if>
    <remove_value name="$Ship"/>
  </on_abort>

</aiscript>