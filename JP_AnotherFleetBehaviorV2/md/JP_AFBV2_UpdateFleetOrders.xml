<?xml version="1.0" encoding="utf-8" ?>

<mdscript name="JP_AFBV2_UpdateFleetOrders" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="JP_AFBV2_UpdateFleetOrders_LOOP" instantiate="true" checkinterval="1s">
      <conditions>
      </conditions>
      <actions>
        <set_value name="$DEBUG" exact="0"/>
        <set_value name="$DebugDirectory" exact="'JP_AnotherFleetBehaviorV2.logs'"/>
        <set_value name="$DebugFileName" exact="'JP_AFBV2_UpdateFleetOrders.xml.log'"/>

        <do_if value="$DEBUG gt 0">
          <debug_to_file append="false" directory="$DebugDirectory" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_AFBV2_UpdateFleetOrders.xml ~ Started ~~' + '\n'"/>
        </do_if>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <set_value name="$CurrentShip" exact="null"/>

        <create_list name="$_Ships"/>
        <find_ship_by_true_owner name="$_Ships" space="player.galaxy" multiple="true" faction="faction.player" owner="faction.player">
          <match class="[class.ship_s, class.ship_m, class.ship_l]"/>
        </find_ship_by_true_owner>

        <do_if value="$_Ships.count gt 0">
          <do_for_each name="$_Ship" in="$_Ships">

            <do_if value="@$_Ship.fleet.commander.defaultorder.id != 'JP_AnotherFleetBehaviorV2' and (@$_Ship.defaultorder.id == 'JP_AFBV2_InterceptionSmall' or @$_Ship.defaultorder.id == 'JP_AFBV2_DefenceSmall' or @$_Ship.defaultorder.id == 'JP_AFBV2_AttackSmall')">
              <cancel_all_orders object="$_Ship"/>
              <create_order object="$_Ship" id="'Escort'" default="true">
                <param name="target" value="$_Ship.fleet.commander"/>
              </create_order>
            </do_if>

            <do_if value="@$_Ship.fleet.commander.defaultorder.id != 'JP_AnotherFleetBehaviorV2' or $_Ship.isunit">
              <continue/>
            </do_if>

            <do_if value="@$_Ship.defaultorder.id != 'JP_AFBV2_InterceptionSmall' and @$_Ship.defaultorder.id != 'JP_AFBV2_DefenceSmall' and @$_Ship.defaultorder.id != 'JP_AFBV2_AttackSmall'">
              <continue/>
            </do_if>

            <do_if value="$_Ship.order.id == 'Flee'">
              <continue/>
            </do_if>

            <set_value name="$CurrentShip" exact="$_Ship"/>

            <!-- Going to repair? -->
            <do_if value="$_Ship.hullpercentage le 90">
              <set_value name="$_HasRepairOrder" exact="false"/>
              <do_for_each name="$_Order" in="$_Ship.orders">
                <do_if value="$_Order.id == 'JP_AFBV2_Go_Repair'">
                  <set_value name="$_HasRepairOrder" exact="true"/>
                  <break/>
                </do_if>
              </do_for_each>
              <do_if value="not $_HasRepairOrder">
                <cancel_all_orders object="$_Ship"/>
                <create_order object="$_Ship" id="'JP_AFBV2_Go_Repair'" immediate="true">
                  <param name="LOOK_FOR_FRIENDLY_STATIONS_WHERE_WE_CAN_REPAIR" value="true"/>
                  <param name="STATION_SEARCH_MAX_GATE_DISTANCE" value="5"/>
                  <param name="DEBUG" value="$DEBUG"/>
                </create_order>
              </do_if>
              <continue/>
            </do_if>

            <!-- Is actual enemy to far away? -->
            <do_if value="$_Ship.order.id == 'Attack'">
              <do_if value="$_Ship.fleet.commander.distanceto.{$_Ship.order.$primarytarget} gt $_Ship.defaultorder.$COMBAT_RANGE">
                <cancel_all_orders object="$_Ship"/>
                <continue/>
              </do_if>
            </do_if>

            <!-- Are we Attacker and we have an actual valid PrimaryTarget? -->
            <do_if value="$_Ship.order.id == 'Attack' and $_Ship.defaultorder.id == 'JP_AFBV2_AttackSmall'">
              <do_if value="$_Ship.defaultorder.$PRIMARY_TARGET != null and $_Ship.fleet.commander.distanceto.{$_Ship.defaultorder.$PRIMARY_TARGET} lt $_Ship.defaultorder.$COMBAT_RANGE">
                <do_if value="$_Ship.order.$primarytarget != $PRIMARY_TARGET">
                  <cancel_all_orders object="$Ship"/>
                  <continue/>
                </do_if>
              </do_if>
            </do_if>

            <do_if value="$_Ship.defaultorder.id == 'JP_AFBV2_AttackSmall'">
              <set_value name="$GoIdle" exact="false"/>
              <signal_cue_instantly cue="JP_UPDATE_ATTACKER_SMALL_CUE"/>
              <continue/>
            </do_if>

            <do_if value="$_Ship.defaultorder.id == 'JP_AFBV2_DefenceSmall'">
              <set_value name="$GoIdle" exact="false"/>
              <signal_cue_instantly cue="JP_UPDATE_DEFENDER_SMALL_CUE"/>
              <continue/>
            </do_if>

            <do_if value="$_Ship.defaultorder.id == 'JP_AFBV2_InterceptionSmall'">
              <set_value name="$GoIdle" exact="false"/>
              <signal_cue_instantly cue="JP_UPDATE_INTERCEPTOR_SMALL_CUE"/>
              <continue/>
            </do_if>

          </do_for_each>
        </do_if>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <do_if value="$DEBUG gt 0">
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_AFBV2_UpdateFleetOrders.xml ~ Finished ~~'"/>
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
        </do_if>

        <remove_value name="$DebugFileName"/>
        <remove_value name="$DebugDirectory"/>
        <remove_value name="$DEBUG"/>
      </actions>
    </cue>

    <cue name="JP_UPDATE_ATTACKER_SMALL_CUE" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$DEBUG" exact="JP_AFBV2_UpdateFleetOrders_LOOP.$DEBUG"/>
        <set_value name="$DebugDirectory" exact="'JP_AnotherFleetBehaviorV2.logs'"/>
        <set_value name="$DebugFileName" exact="'JP_UPDATE_ATTACKER_SMALL_CUE.xml.log'"/>

        <do_if value="$DEBUG gt 0">
          <debug_to_file append="false" directory="$DebugDirectory" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_UPDATE_ATTACKER_SMALL_CUE.xml ~ Started ~~' + '\n'"/>
        </do_if>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <set_value name="$_Ship" exact="JP_AFBV2_UpdateFleetOrders_LOOP.$CurrentShip"/>

        <create_list name="$_FoundEnemyShips"/>
        <set_value name="$_GoAttack" exact="false"/>
        <do_if value="$_Ship.defaultorder.$PRIMARY_TARGET != null">
          <set_value name="$_GoAttack" exact="true"/>
        </do_if>
        <do_if value="@$_Ship.defaultorder.$PRIMARY_TARGET == null and $_Ship.defaultorder.$ATTACK_ENEMIES_IN_RANGE and not $_GoAttack">
          <find_object name="$_FoundEnemyShips" space="$_Ship.sector" multiple="false" append="true">
            <match_relation_to object="$_Ship" relation="enemy"/>
            <match mayattack="$_Ship"/>
            <match knownto="$_Ship.owner"/>
            <match class="$_Ship.defaultorder.$CLASSES_TO_ATTACK"/>
            <match_distance object="$_Ship.fleet.commander" max="$_Ship.defaultorder.$COMBAT_RANGE"/>
          </find_object>
          <do_if value="$_FoundEnemyShips.count gt 0">
            <set_value name="$_GoAttack" exact="true"/>
          </do_if>
          <remove_value name="$_FoundEnemyShips"/>
        </do_if>
        <do_if value="not $_Ship.subordinategroupdockoverride and $_GoAttack">
          <set_value name="$_HasAttackOrder" exact="false"/>
          <set_value name="$_HasUndockOrder" exact="false"/>
          <do_for_each name="$_Order" in="$_Ship.orders">
            <do_if value="$_Order.id == 'Attack'">
              <set_value name="$_HasAttackOrder" exact="true"/>
              <continue/>
            </do_if>
            <do_if value="$_Order.id == 'Undock'">
              <set_value name="$_HasUndockOrder" exact="true"/>
              <continue/>
            </do_if>
          </do_for_each>
          <do_if value="not $_HasAttackOrder and not $_HasUndockOrder">
            <cancel_all_orders object="$_Ship"/>
          </do_if>
          <remove_value name="$_HasUndockOrder"/>
          <remove_value name="$_HasAttackOrder"/>
          <continue/>
        </do_if>
        <do_else>
          <signal_cue_instantly cue="JP_GOIDLE_CUE"/>
        </do_else>

        <remove_value name="$_Ship"/>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <do_if value="$DEBUG gt 0">
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_UPDATE_ATTACKER_SMALL_CUE.xml ~ Finished ~~'"/>
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
        </do_if>

        <remove_value name="$DebugFileName"/>
        <remove_value name="$DebugDirectory"/>
        <remove_value name="$DEBUG"/>
      </actions>
    </cue>

    <cue name="JP_UPDATE_DEFENDER_SMALL_CUE" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$DEBUG" exact="JP_AFBV2_UpdateFleetOrders_LOOP.$DEBUG"/>
        <set_value name="$DebugDirectory" exact="'JP_AnotherFleetBehaviorV2.logs'"/>
        <set_value name="$DebugFileName" exact="'JP_UPDATE_DEFENDER_SMALL_CUE.xml.log'"/>

        <do_if value="$DEBUG gt 0">
          <debug_to_file append="false" directory="$DebugDirectory" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_UPDATE_DEFENDER_SMALL_CUE.xml ~ Started ~~' + '\n'"/>
        </do_if>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <set_value name="$_Ship" exact="JP_AFBV2_UpdateFleetOrders_LOOP.$CurrentShip"/>

        <create_list name="$_FoundEnemyShips"/>
        <set_value name="$_GoAttack" exact="false"/>
        <find_object name="$_FoundEnemyShips" space="$_Ship.sector" multiple="false" append="true">
          <match_relation_to object="$_Ship" relation="enemy"/>
          <match mayattack="$_Ship"/>
          <match knownto="$_Ship.owner"/>
          <match class="$_Ship.defaultorder.$CLASSES_TO_ATTACK"/>
          <match_distance object="$_Ship.fleet.commander" max="$_Ship.defaultorder.$COMBAT_RANGE"/>
        </find_object>
        <do_if value="$_FoundEnemyShips.count gt 0">
          <set_value name="$_GoAttack" exact="true"/>
        </do_if>
        <remove_value name="$_FoundEnemyShips"/>
        <do_if value="not $_Ship.subordinategroupdockoverride and $_GoAttack">
          <set_value name="$_HasAttackOrder" exact="false"/>
          <set_value name="$_HasUndockOrder" exact="false"/>
          <do_for_each name="$_Order" in="$_Ship.orders">
            <do_if value="$_Order.id == 'Attack'">
              <set_value name="$_HasAttackOrder" exact="true"/>
              <continue/>
            </do_if>
            <do_if value="$_Order.id == 'Undock'">
              <set_value name="$_HasUndockOrder" exact="true"/>
              <continue/>
            </do_if>
          </do_for_each>
          <do_if value="not $_HasAttackOrder and not $_HasUndockOrder">
            <cancel_all_orders object="$_Ship"/>
          </do_if>
          <remove_value name="$_HasUndockOrder"/>
          <remove_value name="$_HasAttackOrder"/>
          <continue/>
        </do_if>
        <do_else>
          <signal_cue_instantly cue="JP_GOIDLE_CUE"/>
        </do_else>

        <remove_value name="$_Ship"/>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <do_if value="$DEBUG gt 0">
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_UPDATE_DEFENDER_SMALL_CUE.xml ~ Finished ~~'"/>
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
        </do_if>

        <remove_value name="$DebugFileName"/>
        <remove_value name="$DebugDirectory"/>
        <remove_value name="$DEBUG"/>
      </actions>
    </cue>

    <cue name="JP_UPDATE_INTERCEPTOR_SMALL_CUE" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$DEBUG" exact="JP_AFBV2_UpdateFleetOrders_LOOP.$DEBUG"/>
        <set_value name="$DebugDirectory" exact="'JP_AnotherFleetBehaviorV2.logs'"/>
        <set_value name="$DebugFileName" exact="'JP_UPDATE_INTERCEPTOR_SMALL_CUE.xml.log'"/>

        <do_if value="$DEBUG gt 0">
          <debug_to_file append="false" directory="$DebugDirectory" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_UPDATE_INTERCEPTOR_SMALL_CUE.xml ~ Started ~~' + '\n'"/>
        </do_if>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <set_value name="$_Ship" exact="JP_AFBV2_UpdateFleetOrders_LOOP.$CurrentShip"/>

        <create_list name="$_FoundEnemyShips"/>
        <set_value name="$_GoAttack" exact="false"/>
        <find_object name="$_FoundEnemyShips" space="$_Ship.sector" multiple="false" append="true">
          <match_relation_to object="$_Ship" relation="enemy"/>
          <match mayattack="$_Ship"/>
          <match knownto="$_Ship.owner"/>
          <match class="$_Ship.defaultorder.$CLASSES_TO_ATTACK"/>
          <match_distance object="$_Ship.fleet.commander" max="$_Ship.defaultorder.$COMBAT_RANGE"/>
        </find_object>
        <do_if value="$_FoundEnemyShips.count gt 0">
          <do_for_each name="$_FoundEnemyShip" in="$_FoundEnemyShips">
            <do_if value="@$_FoundEnemyShip.order.id == 'Attack'">
              <do_if value="$_FoundEnemyShip.order.$primarytarget.owner == $_Ship.owner">
                <set_value name="$_GoAttack" exact="true"/>
              </do_if>
            </do_if>
          </do_for_each>
        </do_if>
        <remove_value name="$_FoundEnemyShips"/>
        <do_if value="not $_Ship.subordinategroupdockoverride and $_GoAttack">
          <set_value name="$_HasAttackOrder" exact="false"/>
          <set_value name="$_HasUndockOrder" exact="false"/>
          <do_for_each name="$_Order" in="$_Ship.orders">
            <do_if value="$_Order.id == 'Attack'">
              <set_value name="$_HasAttackOrder" exact="true"/>
              <continue/>
            </do_if>
            <do_if value="$_Order.id == 'Undock'">
              <set_value name="$_HasUndockOrder" exact="true"/>
              <continue/>
            </do_if>
          </do_for_each>
          <do_if value="not $_HasAttackOrder and not $_HasUndockOrder">
            <cancel_all_orders object="$_Ship"/>
          </do_if>
          <remove_value name="$_HasUndockOrder"/>
          <remove_value name="$_HasAttackOrder"/>
          <continue/>
        </do_if>
        <do_else>
          <signal_cue_instantly cue="JP_GOIDLE_CUE"/>
        </do_else>

        <remove_value name="$_Ship"/>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <do_if value="$DEBUG gt 0">
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_UPDATE_INTERCEPTOR_SMALL_CUE.xml ~ Finished ~~'"/>
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
        </do_if>

        <remove_value name="$DebugFileName"/>
        <remove_value name="$DebugDirectory"/>
        <remove_value name="$DEBUG"/>
      </actions>
    </cue>

    <cue name="JP_GOIDLE_CUE" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>
        <set_value name="$DEBUG" exact="JP_AFBV2_UpdateFleetOrders_LOOP.$DEBUG"/>
        <set_value name="$DebugDirectory" exact="'JP_AnotherFleetBehaviorV2.logs'"/>
        <set_value name="$DebugFileName" exact="'JP_GOIDLE_CUE.xml.log'"/>

        <do_if value="$DEBUG gt 0">
          <debug_to_file append="false" directory="$DebugDirectory" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_GOIDLE_CUE.xml ~ Started ~~' + '\n'"/>
        </do_if>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <set_value name="$_Ship" exact="JP_AFBV2_UpdateFleetOrders_LOOP.$CurrentShip"/>

        <set_value name="$_HasDockOrder" exact="false"/>
        <do_for_each name="$_Order" in="$_Ship.orders">
          <do_if value="$_Order.id == 'DockAndWait' or $_Order.id == 'Follow'">
            <set_value name="$_HasDockOrder" exact="true"/>
            <break/>
          </do_if>
        </do_for_each>
        <do_if value="not $_HasDockOrder">
          <do_if value="$_Ship.fleet.commander.dockingallowed.{$_Ship}">
            <cancel_all_orders object="$_Ship"/>
            <create_order object="$_Ship" id="'DockAndWait'" immediate="true">
              <param name="destination" value="$_Ship.fleet.commander"/>
              <param name="dockfollowers" value="true"/>
              <param name="timeout" value="0s"/>
            </create_order>
          </do_if>
          <do_else>
            <cancel_all_orders object="$_Ship"/>
            <create_order object="$_Ship" id="'Follow'" immediate="true">
              <param name="target" value="$_Ship.fleet.commander"/>
            </create_order>
          </do_else>
        </do_if>

        <remove_value name="$_Ship"/>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <do_if value="$DEBUG gt 0">
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_GOIDLE_CUE.xml ~ Finished ~~'"/>
          <debug_to_file directory="$DebugDirectory" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
        </do_if>

        <remove_value name="$DebugFileName"/>
        <remove_value name="$DebugDirectory"/>
        <remove_value name="$DEBUG"/>
      </actions>
    </cue>

  </cues>
</mdscript>