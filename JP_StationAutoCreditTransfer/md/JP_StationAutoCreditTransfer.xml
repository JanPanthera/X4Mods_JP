<?xml version="1.0" encoding="utf-8"?>

<mdscript name="JP_StationAutoCreditTransfer_MD" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
  <cues>

    <cue name="JP_SACT_LOOP" checkinterval="900s" instantiate="true">
      <actions>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <!-- $PlayerBudgetCap ~ Default 1.000.000 Cr ~ Only money above amount X will be transferred automatically from Player to .. -->
        <set_value name="$PlayerBudgetCap" exact="1000000"/>
        <!-- $AdditionalStationMoneyCap ~ Default 1.000.000Cr ~ Money which will be added to the Stations account limit -->
        <set_value name="$AdditionalStationMoneyCap" exact="1000000"/>
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <set_value name="$StationToBuildstorage" exact="true"/>
        <set_value name="$BuildstorageToStation" exact="true"/>
        <set_value name="$PlayerToBuildstorage" exact="if md.JP_SACT_DisablePlayerToTransfers? then false else true"/>
        <set_value name="$PlayerToStation" exact="if md.JP_SACT_DisablePlayerToTransfers? then false else true"/>
        <set_value name="$StationToPlayer" exact="if md.JP_SACT_DisableStationToPlayerTransfers? then false else true"/>
        <set_value name="$BuildstorageToPlayer" exact="true"/>
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        <set_value name="$DEBUG" exact="0"/>
        <set_value name="$DebugFileName" exact="'JP_SACT_LOOP.xml.log'"/>
        <set_value name="$DebugFolderName" exact="'JP_StationAutoCreditTransfer.logs'"/>
        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <do_if value="$DEBUG">
          <debug_to_file append="false" directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_SACT_LOOP.xml ~ Started ~~' + '\n'"/>
          <show_help custom="'JP_SACT_LOOP'" duration="4s" allowclose="true"/>
        </do_if>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <create_list name="$_Stations"/>
        <find_station_by_true_owner name="$_Stations" space="player.galaxy" owner="faction.player" faction="faction.player" multiple="true"/>

        <do_if value="$_Stations.count gt 0">
          <do_for_each name="$_Station" in="$_Stations">

            <set_value name="$StationNeeds" exact="0Cr"/>
            <set_value name="$StationAvailableMoney" exact="0Cr"/>
            <set_value name="$BuildstorageNeeds" exact="0Cr"/>
            <set_value name="$BuildstorageAvailableMoney" exact="0Cr"/>
            <set_value name="$PlayerAvailableMoney" exact="0Cr"/>

            <!-- Transfer money from Station to Buildstorage? -->
            <do_if value="$StationToBuildstorage">
              <signal_cue_instantly cue="JP_SACT_CalculateNeeds"/>
              <set_value name="$_MoneyToTransfer" exact="(if $StationAvailableMoney gt $BuildstorageNeeds then $BuildstorageNeeds else $StationAvailableMoney)Cr"/>
              <do_if value="$_MoneyToTransfer gt 10000Cr and $BuildstorageNeeds gt 100Cr">
                <write_to_logbook category="tips" title="'\033#FF516E38#' + $_Station.knownname + '\033X\033#FF516E38# [' + faction.player + ']\033X'"
                                  text="'\033#A03A7F8F#' + {8888888, 1800} + ':\033X \033#A000CCCC#' + $_Station.name + ' ' + $_Station.buildstorage.knownname + '\033X'"
                                  money="$_MoneyToTransfer"/>
                <set_object_max_budget object="$_Station.buildstorage" amount="$_MoneyToTransfer + $_Station.buildstorage.money"/>
                <transfer_money from="$_Station" to="$_Station.buildstorage" amount="$_MoneyToTransfer"/>
              </do_if>
              <remove_value name="$_MoneyToTransfer"/>
            </do_if>

            <!-- Transfer money from Buildstorage to Station? -->
            <do_if value="$BuildstorageToStation">
              <signal_cue_instantly cue="JP_SACT_CalculateNeeds"/>
              <set_value name="$_MoneyToTransfer" exact="(if $BuildstorageAvailableMoney gt $StationNeeds then $StationNeeds else $BuildstorageAvailableMoney)Cr"/>
              <do_if value="$_MoneyToTransfer ge 10000Cr and $StationNeeds gt 100Cr">
                <write_to_logbook category="tips" title="'\033#FF516E38#' + $_Station.name + ' ' + $_Station.buildstorage.name + '\033X\033#FF516E38# [' + faction.player + ']\033X'"
                                  text="'\033#A03A7F8F#' + {8888888, 1800} + ':\033X \033#A000CCCC#' + $_Station.name + '\033X'"
                                  money="$_MoneyToTransfer"/>
                <set_object_max_budget object="$_Station" amount="$_MoneyToTransfer + $_Station.money"/>
                <transfer_money from="$_Station.buildstorage" to="$_Station" amount="$_MoneyToTransfer"/>
              </do_if>
              <remove_value name="$_MoneyToTransfer"/>
            </do_if>

            <!-- Transfer money from Player to Buildstorage? -->
            <do_if value="$PlayerToBuildstorage">
              <signal_cue_instantly cue="JP_SACT_CalculateNeeds"/>
              <set_value name="$_MoneyToTransfer" exact="(if $PlayerAvailableMoney gt $BuildstorageNeeds then $BuildstorageNeeds else $PlayerAvailableMoney)Cr"/>
              <do_if value="$_MoneyToTransfer ge 10000Cr and $BuildstorageNeeds gt 100Cr">
                <write_to_logbook category="tips" title="'\033#FF516E38#' + player.name + '\033X\033#FF516E38# [' + faction.player + ']\033X'"
                                  text="'\033#A09E0606#' + {8888888, 1800} + ':\033X \033#A000CCCC#' + $_Station.name + ' ' + $_Station.buildstorage.name + '\033X'"
                                  money="-($_MoneyToTransfer)"/>
                <set_object_max_budget object="$_Station.buildstorage" amount="$_MoneyToTransfer + $_Station.buildstorage.money"/>
                <transfer_money from="faction.player" to="$_Station.buildstorage" amount="$_MoneyToTransfer"/>
              </do_if>
              <remove_value name="$_MoneyToTransfer"/>
            </do_if>

            <!-- Transfer money from Player to Station? -->
            <do_if value="$PlayerToStation">
              <signal_cue_instantly cue="JP_SACT_CalculateNeeds"/>
              <set_value name="$_MoneyToTransfer" exact="(if $PlayerAvailableMoney gt $StationNeeds then $StationNeeds else $PlayerAvailableMoney)Cr"/>
              <do_if value="$_MoneyToTransfer ge 100000Cr and $StationNeeds gt 100Cr">
                <write_to_logbook category="tips" title="'\033#FF516E38#' + player.name + '\033X\033#FF516E38# [' + faction.player + ']\033X'"
                                  text="'\033#A09E0606#' + {8888888, 1800} + ':\033X \033#A000CCCC#' + $_Station.name + '\033X'"
                                  money="-($_MoneyToTransfer)"/>
                <set_object_max_budget object="$_Station" amount="($_MoneyToTransfer + $_Station.money)"/>
                <transfer_money from="faction.player" to="$_Station" amount="$_MoneyToTransfer"/>
              </do_if>
              <remove_value name="$_MoneyToTransfer"/>
            </do_if>

            <!-- Transfer money from Station to Player? -->
            <do_if value="$StationToPlayer">
              <signal_cue_instantly cue="JP_SACT_CalculateNeeds"/>
              <set_value name="$_MoneyToTransfer" exact="($StationAvailableMoney)Cr"/>
              <do_if value="$_MoneyToTransfer ge 100000Cr">
                <write_to_logbook category="tips" title="'\033#FF516E38#' + $_Station.name + '\033X\033#FF516E38# [' + faction.player + ']\033X'"
                                  text="'\033#A0E3A624#* ' + {8888888, 1800} + ':\033X \033#A000CCCC#' + player.name + '\033X'"
                                  money="$_MoneyToTransfer"/>
                <transfer_money from="$_Station" to="faction.player" amount="$_MoneyToTransfer"/>
              </do_if>
              <remove_value name="$_MoneyToTransfer"/>
            </do_if>

            <!-- Transfer money from Buildstorage to Player? -->
            <do_if value="$BuildstorageToPlayer">
              <signal_cue_instantly cue="JP_SACT_CalculateNeeds"/>
              <set_value name="$_MoneyToTransfer" exact="($BuildstorageAvailableMoney)Cr"/>
              <do_if value="$_MoneyToTransfer ge 100000Cr">
                <write_to_logbook category="tips" title="'\033#FF516E38#' + $_Station.name + ' ' + $_Station.buildstorage.name + '\033X\033#FF516E38# [' + faction.player + ']\033X'"
                                  text="'\033#A0E3A624#* ' + {8888888, 1800} + ':\033X \033#A000CCCC#' + player.name + '\033X'"
                                  money="$_MoneyToTransfer"/>
                <transfer_money from="$_Station.buildstorage" to="faction.player" amount="$_MoneyToTransfer"/>
              </do_if>
              <remove_value name="$_MoneyToTransfer"/>
            </do_if>

            <remove_value name="$PlayerAvailableMoney"/>
            <remove_value name="$BuildstorageAvailableMoney"/>
            <remove_value name="$BuildstorageNeeds"/>
            <remove_value name="$StationAvailableMoney"/>
            <remove_value name="$StationNeeds"/>

          </do_for_each>
        </do_if>

        <remove_value name="$_Stations"/>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <do_if value="$DEBUG">
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_SACT_LOOP.xml ~ Finished ~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
        </do_if>

        <remove_value name="$DebugFolderName"/>
        <remove_value name="$DebugFileName"/>
        <remove_value name="$DEBUG"/>
        <remove_value name="$BuildstorageToPlayer"/>
        <remove_value name="$StationToPlayer"/>
        <remove_value name="$PlayerToStation"/>
        <remove_value name="$PlayerToBuildstorage"/>
        <remove_value name="$BuildstorageToStation"/>
        <remove_value name="$StationToBuildstorage"/>
        <remove_value name="$AdditionalStationMoneyCap"/>
        <remove_value name="$PlayerBudgetCap"/>

      </actions>
    </cue>

    <cue name="JP_SACT_CalculateNeeds_t" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>

        <set_value name="$DEBUG" exact="JP_SACT_LOOP.$DEBUG"/>
        <set_value name="$DebugFileName" exact="'JP_SACT_CalculateNeeds.xml.log'"/>
        <set_value name="$DebugFolderName" exact="JP_SACT_LOOP.$DebugFolderName"/>

        <do_if value="$DEBUG">
          <debug_to_file append="false" directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_SACT_CalculateNeeds.xml ~ Started ~~' + '\n'"/>
        </do_if>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <set_value name="$_Station" exact="JP_SACT_LOOP.$_Station"/>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <do_if value="$DEBUG">
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_SACT_CalculateNeeds.xml ~ Finished ~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
        </do_if>

        <remove_value name="$DebugFolderName"/>
        <remove_value name="$DebugFileName"/>
        <remove_value name="$DEBUG"/>

      </actions>
    </cue>

    <cue name="JP_SACT_CalculateNeeds" instantiate="true">
      <conditions>
        <event_cue_signalled/>
      </conditions>
      <actions>

        <set_value name="$DEBUG" exact="JP_SACT_LOOP.$DEBUG"/>
        <set_value name="$DebugFileName" exact="'JP_SACT_CalculateNeeds.xml.log'"/>
        <set_value name="$DebugFolderName" exact="JP_SACT_LOOP.$DebugFolderName"/>

        <do_if value="$DEBUG">
          <debug_to_file append="false" directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_SACT_CalculateNeeds.xml ~ Started ~~' + '\n'"/>
        </do_if>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <set_value name="$_Station" exact="JP_SACT_LOOP.$_Station"/>
        <set_value name="JP_SACT_LOOP.$StationNeeds" exact="0Cr"/>
        <set_value name="JP_SACT_LOOP.$StationAvailableMoney" exact="0Cr"/>
        <set_value name="JP_SACT_LOOP.$BuildstorageNeeds" exact="0Cr"/>
        <set_value name="JP_SACT_LOOP.$BuildstorageAvailableMoney" exact="0Cr"/>
        <set_value name="JP_SACT_LOOP.$PlayerAvailableMoney" exact="0Cr"/>

        <do_if value="$_Station.supplyorders.list.count gt 0">
          <do_for_each name="$Ware" in="$_Station.supplyorders.list" counter="$_it">
            <set_value name="$WareAmount" exact="$_Station.supplyorders.{$Ware}.count - $_Station.ammostorage.{$Ware.objectmacro}.count"/>
            <do_for_each name="$Ressource" in="$Ware.resources.list" counter="$_jt">
              <set_value name="JP_SACT_LOOP.$StationNeeds" operation="add" exact="(($Ressource.averageprice / 100) * $Ware.resources.{$Ressource}.count) * $WareAmount"/>
            </do_for_each>
            <set_value name="$WareAmount" exact="0"/>
          </do_for_each>
          <remove_value name="$WareAmount"/>
        </do_if>

        <do_if value="$DEBUG">
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$StationName: ' + $_Station.knownname"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$StationNeededResupplyMoney: ' + JP_SACT_LOOP.$StationNeeds + ' Cr'"/>
        </do_if>

        <set_value name="JP_SACT_LOOP.$StationNeeds" exact="(JP_SACT_LOOP.$StationNeeds + ($_Station.productionmoney / 100) + JP_SACT_LOOP.$AdditionalStationMoneyCap) - ($_Station.money / 100)"/>
        <set_value name="JP_SACT_LOOP.$StationAvailableMoney" exact="-(JP_SACT_LOOP.$StationNeeds)"/>
        <set_value name="JP_SACT_LOOP.$BuildstorageNeeds" exact="($_Station.buildstorage.wantedmoney / 100) - ($_Station.buildstorage.money / 100)"/>
        <set_value name="JP_SACT_LOOP.$BuildstorageAvailableMoney" exact="-(JP_SACT_LOOP.$BuildstorageNeeds)"/>
        <set_value name="JP_SACT_LOOP.$PlayerAvailableMoney" exact="(player.money / 100) - JP_SACT_LOOP.$PlayerBudgetCap"/>

        <do_if value="$DEBUG">
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$StationProductionMoney: ' + ($_Station.productionmoney / 100) + ' Cr'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$AdditionalStationMoneyCap: ' + JP_SACT_LOOP.$AdditionalStationMoneyCap + ' Cr'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$StationNeeds: ' + JP_SACT_LOOP.$StationNeeds + ' Cr'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$StationMoney: ' + ($_Station.money / 100) + ' Cr'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$StationAvailableMoney: ' + JP_SACT_LOOP.$StationAvailableMoney + ' Cr'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$BuildstorageNeeds: ' + JP_SACT_LOOP.$BuildstorageNeeds + ' Cr'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$BuildstorageMoney: ' + ($_Station.buildstorage.money / 100) + ' Cr'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$BuildstorageAvailableMoney: ' + JP_SACT_LOOP.$BuildstorageAvailableMoney + ' Cr'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$PlayerMoney: ' + (player.money / 100) + ' Cr'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'$PlayerAvailableMoney: ' + JP_SACT_LOOP.$PlayerAvailableMoney + ' Cr'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n'"/>
        </do_if>

        <remove_value name="$_Station"/>

        <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

        <do_if value="$DEBUG">
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'[' + player.systemtime.{'%F - %X'} + '] ' + '~~ JP_SACT_CalculateNeeds.xml ~ Finished ~~'"/>
          <debug_to_file directory="$DebugFolderName" name="$DebugFileName" text="'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~'"/>
        </do_if>

        <remove_value name="$DebugFolderName"/>
        <remove_value name="$DebugFileName"/>
        <remove_value name="$DEBUG"/>

      </actions>
    </cue>

  </cues>
</mdscript>