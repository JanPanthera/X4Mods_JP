<?xml version="1.0" encoding="utf-8"?>

<aiscript name="JP_ResupplyNavBeacons" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="aiscripts.xsd">

  <order id ="JP_ResupplyNavBeacons" name="JP ResupplyNavBeacons" category="internal" infinite="false">
    <params>
      <param name="COUNT" type="internal" default="5" text="NavBeaconsCount"/>
      <param name="DEBUG" type="bool" text="DebugText"/>
    </params>
  </order>

  <interrupts>
  </interrupts>

  <init>
  </init>

  <attention min="unknown">
    <actions>

      <wait exact="1ms"/>
      <label name="START"/>

      <label name="INIT"/>
      <set_value name="$SHIP" exact="this.ship"/>

      <!-- Start Resupplying -->
      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

      <do_if value="$DEBUG">
        <debug_text text="'Start resupplying of nav beacons...'"/>
      </do_if>
      <set_value name="$AmmoTable" exact="table[]"/>
      <set_value name="$AmmoTable.{ware.waypointmarker_01}" exact="$COUNT"/>
      <find_station space="player.galaxy" checkoperational="true" cansupplyclass="$SHIP.class" name="$Stations" multiple="true">
        <match mayattack="$SHIP" negate="true"/>
      </find_station>
      <do_if value="$DEBUG">
        <debug_text text="'Found stations where we could resupply nav beacons...'"/>
      </do_if>
      <run_script name="'JP_SortListByDistance'">
        <param name="LIST" value="$Stations" />
        <param name="OBJECT" value="$SHIP"/>
        <param name="DEBUG" value="$DEBUG"/>
        <save_retval name="SORTED_LIST" variable="$SortedList"/>
      </run_script>
      <set_value name="$Stations" exact="$SortedList"/>
      <remove_value name="$SortedList"/>
      <set_value name="$Price" exact="0Cr"/>
      <set_value name="$Price" operation="add" exact="$Stations.last.buildprice.{ware.waypointmarker_01} * $COUNT"/>
      <do_if value="$DEBUG">
        <debug_text text="'Station to resupply: %1 [%2]'.[$Stations.last.knownname, $Stations.last.idcode]"/>
        <debug_text text="'%1Cr for %2x %3'.[$Price, $COUNT, ware.waypointmarker_01]"/>
      </do_if>
      <!-- Price doesn't work? -->
      <add_build_to_modify_ship buildobject="$SHIP" object="$Stations.last" ammo="$AmmoTable" price="$Price" immediate="true" internal="true"/>
      <wait exact="1s"/>
      <remove_value name="$Price"/>
      <remove_value name="$AmmoTable"/>
      <remove_value name="$Stations"/>

      <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->

      <label name="CLEANUP"/>
      <remove_value name="$SHIP"/>

      <label name="FINISH"/>
      <wait exact="1ms"/>

    </actions>
  </attention>

  <on_abort>
  </on_abort>

</aiscript>